
-- name: test_mv_increment_refresh_on_hive

create external catalog mv_hive_${uuid0}
properties
(
    "type" = "hive",
    "hive.catalog.type" = "hive",
    "hive.metastore.uris" = "${hive_metastore_uris}"
);

-- create hive table
set catalog mv_hive_${uuid0};
create database mv_hive_db_${uuid0};
use mv_hive_db_${uuid0};


CREATE TABLE t1 (
  num int,
  dt date
)
PARTITION BY (dt);
INSERT INTO t1 VALUES 
  (1,"2020-06-15"),(2,"2020-06-18"),(3,"2020-06-21"),(4,"2020-06-24"),
  (1,"2020-07-02"),(2,"2020-07-05"),(3,"2020-07-08"),(4,"2020-07-11"),
  (1,"2020-07-16"),(2,"2020-07-19"),(3,"2020-07-22"),(4,"2020-07-25"),
  (2,"2020-06-15"),(3,"2020-06-18"),(4,"2020-06-21"),(5,"2020-06-24"),
  (2,"2020-07-02"),(3,"2020-07-05"),(4,"2020-07-08"),(5,"2020-07-11");

set catalog default_catalog;
create database db_${uuid0};
use db_${uuid0};

CREATE MATERIALIZED VIEW test_mv1 
PARTITION BY dt 
REFRESH DEFERRED MANUAL AS 
  SELECT * FROM mv_hive_${uuid0}.mv_hive_db_${uuid0}.t1;

REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;